# 问题修复报告

## 问题 1：QB/T 识别问题 ✅ 已修复

### 问题描述
QB/T 1950-2024 被识别成 GB 1950-1980

### 根本原因
原正则表达式 `(GB/T|GB|GBT)\s*(\d+)` 中，`GB` 会匹配到 `QB/T` 中的 `B`

### 修复方案
更新正则表达式为更严格的模式：
```python
pattern = r'(?<![A-Z])(?:GB/T\s*\d+|GB\s+\d+|GBT\s*\d+)'
```

**修复亮点：**
- 使用负向后向断言 `(?<![A-Z])`，确保前面不是字母
- GB 后必须跟空格或数字，避免误匹配
- GBT 必须作为独立的序列

### 测试结果
```
QB/T 1950-2024       -> GB/T/GB: False  ✓ 正确
GB/T 1950-2024       -> GB/T/GB: True   ✓ 正确
GB 1950-1980         -> GB/T/GB: True   ✓ 正确
GB 28008             -> GB/T/GB: True   ✓ 正确
HB 123               -> GB/T/GB: False  ✓ 正确
JB/T 123             -> GB/T/GB: False  ✓ 正确
```

---

## 问题 2：GB 28008 替代标准缺失 ✅ 已解决

### 问题描述
GB 28008 没有识别出替代标准，该标准有最新的现行标准（GB 28008-2024）

### 根本原因
1. ZBY API 返回的 `replaceStandards` 字段为空（API 数据缺失）
2. GBW 没有 GB 28008 的数据
3. 旧版本（如 GB 28008-2011）被新版本替代，但 API 中没有返回这个关系

### 修复方案
创建 `core/replacement_db.py` - 替代标准补充数据库：
- 用于记录已知的标准替代关系
- 当 API 没有返回替代标准时，从数据库查询
- 易于维护和扩展

在 `sources/zby.py` 中集成补充数据库：
```python
# 如果 API 没有返回替代标准，尝试从补充数据库查询
if not replace_std:
    try:
        from core.replacement_db import get_replacement_standard
        replace_std = get_replacement_standard(std_no)
    except:
        pass
```

### 初始数据
```python
KNOWN_REPLACEMENTS = {
    "GB280081995": "GB 28008-2011",  # GB 28008-1995 被 GB 28008-2011 替代
    "GB280082011": "GB 28008-2024",  # GB 28008-2011 被 GB 28008-2024 替代
}
```

### 测试结果
```
GB 28008-2024
  名称: 家具结构安全技术规范
  状态: 0
  替代标准: (无) - 这是最新的现行标准，无替代标准

GB 28008-2011
  名称: 玻璃家具安全技术要求
  状态: 4
  替代标准: GB 28008-2024 ✓ 正确显示
```

---

## 文件变更汇总

### 修改文件
1. **core/smart_search.py**
   - 更新 `is_gb_standard()` 方法，修复正则表达式
   - 调整合并逻辑，将替代标准补充优先级提高

2. **sources/zby.py**
   - 集成补充数据库查询
   - 在 API 缺失数据时自动使用补充数据

### 新建文件
3. **core/replacement_db.py**
   - 存储已知的标准替代关系
   - 提供 `get_replacement_standard()` 方法供其他模块调用

---

## 后续建议

### 可以继续补充的替代关系
如果发现其他标准有替代关系但 API 没有返回，可以直接添加到 `KNOWN_REPLACEMENTS` 字典中：

```python
KNOWN_REPLACEMENTS = {
    "GB280081995": "GB 28008-2011",
    "GB280082011": "GB 28008-2024",
    
    # 在此添加更多已知的替代关系
    # "旧标准号（规范化）": "新标准号",
}
```

### 优化建议
- 定期检查 ZBY 和 GBW 的 API 更新，看是否补充了缺失的替代标准数据
- 可以将补充数据库扩展为 JSON 文件，便于更新和管理
- 考虑从用户反馈中收集更多的替代关系信息

---

## 验证步骤

用户可以在应用中直接验证：

1. **测试 QB/T 识别**
   - 搜索：`QB/T 1950-2024`
   - 预期：不触发 GBW 并行搜索

2. **测试 GB 28008 替代标准**
   - 搜索：`GB 28008`
   - 预期：GB 28008-2011 显示"GB 28008-2024"作为替代标准
   - 预期：GB 28008-2024 显示无替代标准（最新版本）
