# 本地运行指南

## 快速启动

### 1. 启动桌面应用

```bash
cd c:\Users\PengLinHao\Desktop\合并\Multi-source-downloader
python desktop_app.py
```

或者使用 Python 虚拟环境：

```bash
.venv_win7\Scripts\python.exe desktop_app.py
```

### 2. 首次启动

应用首次启动时会弹出以下界面：

#### 🔐 密码验证对话框
- 输入 6 位数字密码
- 密码 = 反转今天的日期（例如：2026年1月8日 → 8012602）
- 最多允许 5 次错误尝试

#### ✅ 主应用窗口
启动成功后显示主界面：

```
┌─────────────────────────────────────────────────────────┐
│ 标准文献检索系统                                          │
├──────────────────────────────────────────────────────────┤
│ [搜索框] 📍 路径: downloads [🔍 选路径] [📁 打开]        │
│                                                          │
│ ┌─── 左侧：搜索结果 ─────────────────────────────────┐  │
│ │                                                    │  │
│ │ 序号 | 标准号 | 名称 | 发布 | 实施 | 状态 | 源     │  │
│ │ ──────────────────────────────────────────────     │  │
│ │ [空，需要搜索]                                     │  │
│ │                                                    │  │
│ └────────────────────────────────────────────────────┘  │
│                                                          │
│ ┌─── 右侧：日志输出 ────────────────────────────────┐  │
│ │ 🟢 应用已启动，等待搜索...                         │  │
│ │                                                    │  │
│ └────────────────────────────────────────────────────┘  │
│                                                          │
│ [☑ 全选] [⚙️ 设置] [💾 导出CSV] [📥 下载]              │
│ [🚀 批量下载]                                           │
└──────────────────────────────────────────────────────────┘
```

---

## 主要功能

### 搜索标准
1. 在搜索框输入标准号或关键词（例如 "GB/T 3324"）
2. 按回车或点击搜索按钮
3. 系统并行从三个源搜索：
   - 📍 GBW（国家标准平台）
   - 📍 BY（内部系统）
   - 📍 ZBY（标准云 - 使用 Playwright）

### 下载文件
1. 在搜索结果中选中目标行
2. 点击"📥 下载"按钮
3. 系统自动选择可用源并下载 PDF
4. 下载进度和日志实时显示在右侧

### 批量下载
1. 准备包含标准号的 CSV/TXT 文件（每行一个）
2. 点击"🚀 批量下载"按钮
3. 选择文件并开始批量下载

### 配置设置
1. 点击"⚙️ 设置"按钮
2. 在设置对话框中修改：
   - **API 模式**：本地 or 远程
   - **数据源**：启用/禁用 GBW、BY、ZBY
   - **搜索配置**：结果数、重试次数等
   - **下载目录**：自定义保存路径
3. 点击"✓ 保存"，配置立即生效

---

## ⚙️ 设置对话框（新功能）

打开"⚙️ 设置"后，可配置：

### API 模式（重要！）
```
📍 本地模式（推荐）
├─ API 在本地进程内运行
├─ 性能最佳，隐私最强
├─ 无需额外的 VPS
└─ 默认配置

🌐 远程模式（可选）
├─ 连接到 VPS 部署的 API
├─ 支持多用户共享
├─ 需要配置 API 地址
└─ 增加 3-5% 网络延迟
```

### 数据源配置
```
✓ GBW (国家标准平台) - HTTP API
✓ BY (内部系统) - HTTP API
✓ ZBY (标准云) - 需要 Playwright + 浏览器
```

### 搜索配置
```
返回结果数：10-500（默认 100）
最大重试次数：1-10（默认 3）
重试延迟：1-30 秒（默认 2）
```

### 本地模式配置
```
下载目录：downloads（默认）
请求超时：30 秒（默认）
```

---

## 📊 性能指标

### 搜索性能（本地模式）

```
搜索 "GB/T 3324":

GBW:  0.60 秒 ✓ 快
BY:   0.57 秒 ✓ 快
ZBY:  11.7 秒 ⚠️ 较慢（Playwright 启动开销）

并行搜索（三个源同时）：11.7 秒
```

### 远程模式额外延迟

```
网络往返：+200-400ms
总体影响：+3-5%（可接受）
```

---

## 📝 日志说明

### 日志输出示例

```
🟢 应用已启动，等待搜索...

🔍 开始搜索: GB/T 3324
├─ 正在查询 GBW...
│  └─ ✓ GBW 完成: 2 条
├─ 正在查询 BY...
│  └─ ✓ BY 完成: 1 条
└─ 正在查询 ZBY...
   └─ ✓ ZBY 完成: 1 条

✅ 搜索完成，共 4 条结果（去重后）

📥 开始下载: GB/T 3324-2024
├─ 匹配到: GB/T 3324-2024
├─ 标准名称: 圆锥滚子轴承基本参数与尺寸
├─ 正在尝试下载...
└─ ✅ 下载成功 [GBW] -> downloads/GB_T_3324-2024.pdf
```

---

## ⚠️ 常见问题

### Q1: 启动时要求密码，密码是什么？
**A**: 密码是反转今天的日期，例如：
```
今天：2026-01-08
反转：8012602
```

### Q2: ZBY 搜索很慢，怎样加速？
**A**: ZBY 使用 Playwright 控制浏览器，首次启动慢是正常的。可以：
- 禁用 ZBY 源（设置 → 取消勾选 ZBY）
- 增加超时时间（设置 → 本地超时改为 60 秒）

### Q3: 搜索结果为空，怎么办？
**A**: 检查以下几点：
- 确保有网络连接
- 检查日志输出，看是否有错误信息
- 在设置中确保至少启用了一个数据源
- 尝试用更简单的搜索词

### Q4: 无法下载，提示"所有来源均未成功"？
**A**: 可能原因：
- 网络不通（检查网络连接）
- 该标准号不存在（尝试搜索看是否有结果）
- 标准没有电子版本（某些标准可能无 PDF）
- 服务器限流（等待几分钟后重试）

### Q5: 如何切换到远程模式？
**A**: 
1. 打开设置
2. 选择"🌐 远程（VPS 部署）"
3. 输入 API 地址（如 http://vps-ip:8000）
4. 点击保存

---

## 🛠️ 故障排除

### 应用无法启动

```bash
# 检查 Python 环境
.venv_win7\Scripts\python.exe --version

# 检查依赖
pip list | find "PySide"

# 尝试重新安装
pip install -r requirements.txt
```

### Playwright 找不到浏览器

```bash
# 安装 Playwright 浏览器
playwright install chromium
```

### 密码验证失败

- 清除认证记录：删除 `~/.auth_record.json`
- 重新启动应用
- 输入正确的密码（反转日期）

### ZBY 搜索失败

```
原因可能：
❌ Playwright 未安装
❌ 浏览器进程启动失败
❌ 网络连接问题
❌ ZBY 网站服务异常

解决：
✅ pip install playwright
✅ playwright install chromium
✅ 检查网络
✅ 禁用 ZBY，用 GBW/BY 替代
```

---

## 📚 相关文档

- **API 使用指南**：config/API_CONFIG_GUIDE.md
- **实现总结**：config/IMPLEMENTATION_SUMMARY.md
- **架构决策**：config/ARCHITECTURE_GUIDE.md
- **完成报告**：COMPLETION_REPORT.md

---

## 🔧 配置文件位置

所有配置存储在：`config/api_config.json`

```json
{
  "mode": "local",
  "local_output_dir": "downloads",
  "enable_sources": ["gbw", "by", "zby"],
  ...
}
```

修改配置有两种方式：
1. **通过 UI**：打开设置对话框修改（推荐）
2. **手动编辑**：直接编辑 JSON 文件（高级用户）

---

## 📌 快速命令

```bash
# 启动应用
python desktop_app.py

# 运行测试
python test_api_config.py

# 查看日志
python -u desktop_app.py  # 不缓存输出

# 清除缓存
rm -r downloads/*
rm config/api_config.json  # 重置配置
```

---

## ✅ 应该看到什么

应用启动成功的标志：

```
✅ 弹出密码输入对话框（6位数字）
✅ 输入密码后进入主应用窗口
✅ 右侧日志显示"应用已启动，等待搜索..."
✅ 左侧是空的搜索结果表
✅ 工具栏按钮都可点击
✅ 设置对话框能正常打开
```

如果一切正常，🎉 **祝贺！应用已成功运行！**

现在你可以尝试：
1. 搜索一个标准号（如 "GB/T 3324"）
2. 在设置中修改配置
3. 下载一个 PDF 文件

---

**任何问题都可以检查右侧的日志输出，它会显示详细的错误信息。**
