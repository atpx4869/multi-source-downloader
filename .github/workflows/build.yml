name: Build MultiSourceDownloader v4.0

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  VERSION: "4.0.0"
  NUITKA_VERSION: "1.8.0"

jobs:
  build-nuitka-win10:
    name: "Build Win10+ (Python 3.11 + Nuitka)"
    runs-on: windows-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Display Python info
      run: |
        python --version
        pip --version
      shell: pwsh
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools
        pip install -r requirements.txt
        pip install nuitka==${{ env.NUITKA_VERSION }} ordered-set zstandard
      shell: pwsh
      continue-on-error: false
    
    - name: Verify dependencies
      run: |
        Write-Host "Verifying installed packages..." -ForegroundColor Cyan
        python -c "import PySide6; import pandas; import numpy; import onnxruntime; print('All dependencies verified')"
      shell: pwsh
    
    - name: Create auth cache
      run: |
        if (-not (Test-Path "app/.auth_cache")) {
          New-Item -Path "app/.auth_cache" -ItemType File -Force | Out-Null
          Write-Host "Created .auth_cache"
        }
      shell: pwsh
    
    - name: Convert icon
      run: |
        python -c "from PIL import Image; img = Image.open('core/logo.png'); img.save('app.ico', format='ICO', sizes=[(256,256)]); print('Icon converted')"
        if (Test-Path "app.ico") { Write-Host "Icon created successfully" -ForegroundColor Green }
      shell: pwsh
    
    - name: Compile with Nuitka
      timeout-minutes: 90
      run: |
        Write-Host "Starting Nuitka compilation for Win10+..." -ForegroundColor Cyan
        Write-Host "Python 3.11 + PySide6" -ForegroundColor Cyan
        python -m nuitka --onefile --standalone `
          --windows-console-mode=disable `
          --enable-plugin=pyside6 `
          --windows-icon-from-ico=app.ico `
          --include-data-file=core/logo.png=core/logo.png `
          --include-data-file=app/.auth_cache=app/.auth_cache `
          --assume-yes-for-downloads `
          --output-dir=dist `
          --output-filename=MultiSourceDownloader.exe `
          --lto=auto `
          desktop_app.py
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Nuitka compilation completed successfully" -ForegroundColor Green
        } else {
          Write-Host "Compilation failed with exit code: $LASTEXITCODE" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
    
    - name: Verify executable
      run: |
        if (Test-Path "dist/MultiSourceDownloader.exe") {
          $exe = Get-Item "dist/MultiSourceDownloader.exe"
          Write-Host "âœ“ Executable created: $($exe.Name)" -ForegroundColor Green
          Write-Host "  Size: $([math]::Round($exe.Length / 1MB, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âœ— Executable not found!" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
    
    - name: Get build info
      id: build_info
      run: |
        $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $exe = Get-Item dist/MultiSourceDownloader.exe
        $sizeMB = [math]::Round($exe.Length / 1MB, 2)
        $hash = (Get-FileHash dist/MultiSourceDownloader.exe -Algorithm SHA256).Hash.Substring(0, 16)
        echo "date=$date" >> $env:GITHUB_OUTPUT
        echo "size=$sizeMB" >> $env:GITHUB_OUTPUT
        echo "hash=$hash" >> $env:GITHUB_OUTPUT
        Write-Host "Build Info:" -ForegroundColor Cyan
        Write-Host "  Date: $date"
        Write-Host "  Size: $sizeMB MB"
        Write-Host "  Hash: $hash"
      shell: pwsh
    
    - name: Create version info
      env:
        BUILD_DATE: ${{ steps.build_info.outputs.date }}
        BUILD_SIZE: ${{ steps.build_info.outputs.size }}
        BUILD_HASH: ${{ steps.build_info.outputs.hash }}
        NUITKA_VER: ${{ env.NUITKA_VERSION }}
      run: |
        $versionInfo = @"
# MultiSourceDownloader v4.0 - Windows 10+

## Build Information
- **Build Date**: $env:BUILD_DATE
- **File Size**: $env:BUILD_SIZE MB
- **Hash (SHA256)**: $env:BUILD_HASH...
- **Compiler**: Nuitka $env:NUITKA_VER
- **Python Version**: 3.11
- **UI Framework**: PySide6 6.4+
- **Target OS**: Windows 10, 11

## Performance Features
- âš¡ Fast startup: 1-2 seconds
- ğŸ”¥ Native C-compiled speed
- ğŸ’¾ Optimized binary size (30-40% smaller than PyInstaller)
- ğŸ“ Full UTF-8 and Emoji support
- ğŸ¨ Modern UI with smooth animations

## System Requirements
- Windows 10 or later
- No additional runtime required
- ~300-400 MB disk space
"@
        $versionInfo | Out-File -FilePath "dist/VERSION.txt" -Encoding UTF8
        Write-Host "Version info created" -ForegroundColor Green
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MultiSourceDownloader-v4.0-win64
        path: |
          dist/MultiSourceDownloader.exe
          dist/VERSION.txt
        retention-days: 90
        if-no-files-found: error
    
    - name: Build summary
      run: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘  Win10+ Build Completed Successfully!      â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host "  Executable: MultiSourceDownloader.exe" -ForegroundColor White
        Write-Host "  Size: ${{ steps.build_info.outputs.size }} MB" -ForegroundColor White
        Write-Host "  Python: 3.11 | PySide6" -ForegroundColor Gray
        Write-Host ""
      shell: pwsh

  build-nuitka-win7:
    name: "Build Win7 (Python 3.8 + Nuitka)"
    runs-on: windows-2019
    timeout-minutes: 120
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python 3.8
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
        cache: 'pip'
    
    - name: Display Python info
      run: |
        python --version
        pip --version
      shell: pwsh
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools
        pip install -r requirements_win7.txt
        pip install nuitka==${{ env.NUITKA_VERSION }} ordered-set zstandard
      shell: pwsh
      continue-on-error: false
    
    - name: Verify dependencies
      run: |
        Write-Host "Verifying installed packages..." -ForegroundColor Cyan
        python -c "import PySide2; import pandas; print('Dependencies verified')"
      shell: pwsh
    
    - name: Create auth cache
      run: |
        if (-not (Test-Path "app/.auth_cache")) {
          New-Item -Path "app/.auth_cache" -ItemType File -Force | Out-Null
          Write-Host "Created .auth_cache"
        }
      shell: pwsh
    
    - name: Convert icon
      run: |
        python -c "from PIL import Image; img = Image.open('core/logo.png'); img.save('app.ico', format='ICO', sizes=[(256,256)]); print('Icon converted')"
        if (Test-Path "app.ico") { Write-Host "Icon created successfully" -ForegroundColor Green }
      shell: pwsh
    
    - name: Compile with Nuitka
      timeout-minutes: 90
      run: |
        Write-Host "Starting Nuitka compilation for Win7..." -ForegroundColor Cyan
        Write-Host "Python 3.8 + PySide2" -ForegroundColor Cyan
        python -m nuitka --onefile --standalone `
          --windows-console-mode=disable `
          --enable-plugin=pyside2 `
          --windows-icon-from-ico=app.ico `
          --include-data-file=core/logo.png=core/logo.png `
          --include-data-file=app/.auth_cache=app/.auth_cache `
          --assume-yes-for-downloads `
          --output-dir=dist `
          --output-filename=MultiSourceDownloader-Win7.exe `
          --lto=auto `
          desktop_app.py
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Nuitka compilation completed successfully" -ForegroundColor Green
        } else {
          Write-Host "Compilation failed with exit code: $LASTEXITCODE" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
    
    - name: Verify executable
      run: |
        if (Test-Path "dist/MultiSourceDownloader-Win7.exe") {
          $exe = Get-Item "dist/MultiSourceDownloader-Win7.exe"
          Write-Host "âœ“ Executable created: $($exe.Name)" -ForegroundColor Green
          Write-Host "  Size: $([math]::Round($exe.Length / 1MB, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âœ— Executable not found!" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
    
    - name: Get build info
      id: build_info_win7
      run: |
        $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $exe = Get-Item dist/MultiSourceDownloader-Win7.exe
        $sizeMB = [math]::Round($exe.Length / 1MB, 2)
        $hash = (Get-FileHash dist/MultiSourceDownloader-Win7.exe -Algorithm SHA256).Hash.Substring(0, 16)
        echo "date=$date" >> $env:GITHUB_OUTPUT
        echo "size=$sizeMB" >> $env:GITHUB_OUTPUT
        echo "hash=$hash" >> $env:GITHUB_OUTPUT
        Write-Host "Build Info:" -ForegroundColor Cyan
        Write-Host "  Date: $date"
        Write-Host "  Size: $sizeMB MB"
        Write-Host "  Hash: $hash"
      shell: pwsh
    
    - name: Create version info
      env:
        BUILD_DATE: ${{ steps.build_info_win7.outputs.date }}
        BUILD_SIZE: ${{ steps.build_info_win7.outputs.size }}
        BUILD_HASH: ${{ steps.build_info_win7.outputs.hash }}
        NUITKA_VER: ${{ env.NUITKA_VERSION }}
      run: |
        $versionInfo = @"
# MultiSourceDownloader v4.0 - Windows 7+

## Build Information
- **Build Date**: $env:BUILD_DATE
- **File Size**: $env:BUILD_SIZE MB
- **Hash (SHA256)**: $env:BUILD_HASH...
- **Compiler**: Nuitka $env:NUITKA_VER
- **Python Version**: 3.8
- **UI Framework**: PySide2 5.15+
- **Target OS**: Windows 7, 8, 10, 11

## Performance Features
- âš¡ Fast startup: 1-2 seconds
- ğŸ”¥ Native C-compiled speed
- ğŸ’¾ Optimized binary size (30-40% smaller than PyInstaller)
- ğŸ“ Full UTF-8 and Emoji support
- ğŸ¯ Compatible with older Windows versions

## System Requirements
- Windows 7 or later (including 8, 10, 11)
- No additional runtime required
- ~300-400 MB disk space
"@
        $versionInfo | Out-File -FilePath "dist/VERSION_Win7.txt" -Encoding UTF8
        Write-Host "Version info created" -ForegroundColor Green
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MultiSourceDownloader-v4.0-win7
        path: |
          dist/MultiSourceDownloader-Win7.exe
          dist/VERSION_Win7.txt
        retention-days: 90
        if-no-files-found: error
    
    - name: Build summary
      run: |
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘  Win7 Build Completed Successfully!        â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host "  Executable: MultiSourceDownloader-Win7.exe" -ForegroundColor White
        Write-Host "  Size: ${{ steps.build_info_win7.outputs.size }} MB" -ForegroundColor White
        Write-Host "  Python: 3.8 | PySide2" -ForegroundColor Gray
        Write-Host ""
      shell: pwsh
